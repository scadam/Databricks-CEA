# Databricks Custom Engine Agent (Python on Azure Functions)

This repository contains a Microsoft 365 custom engine agent implemented with **Python**, hosted on **Azure Functions**, and reachable through the Bot Framework `/api/messages` endpoint. Instead of OpenAI, the bot calls a **Databricks Serving Endpoint** via their OpenAI-compatible API.

The repo is ready to run in three contexts:

1. **VS Code + Microsoft 365 Agents Toolkit** (F5 debug targets)
2. **Agents Playground CLI** for quick local testing
3. **Azure Functions host** for manual local runs or deployments

---

## Prerequisites

| Tool | Purpose |
| --- | --- |
| [Python 3.11+](https://www.python.org/downloads/) | Primary runtime for the Azure Function and unit tests |
| [Azure Functions Core Tools v4](https://learn.microsoft.com/azure/azure-functions/functions-run-local?tabs=python) | Local host + publish pipeline |
| [Microsoft 365 Agents Toolkit v5+](https://aka.ms/teams-toolkit) | Provision/deploy, VS Code debug targets, `.env` lifecycle |
| [Node.js 18+](https://nodejs.org/) | Required by the Toolkit tasks and Playground CLI |
| Azure subscription + Microsoft 365 tenant | Needed to provision bot resources and sideload the app |
| Databricks serving endpoint + PAT | Back-end LLM provider |

Recommended VS Code extensions:

- Microsoft 365 Agents Toolkit
- Azure Functions
- Python

---

## Quick start (clean environment)

1. **Clone & install tooling**

	```powershell
	git clone https://github.com/scadam/Databricks-CEA.git
	cd Databricks-CEA
	python -m venv .venv
	.venv\Scripts\Activate.ps1
	python -m pip install -r requirements-dev.txt
	```

2. **Create local settings** – copy the sample file and fill in values (use placeholders until you provision via Toolkit):

	```powershell
	Copy-Item local.settings.sample.json local.settings.json
	```

	- `MicrosoftAppId`, `MicrosoftAppTenantId`, and `MicrosoftAppPassword` will be generated by Teams Toolkit when you run **Start App Locally**. Leave the defaults (`0000...`) for now.
	- Set `DATABRICKS_BASE_URL`, `DATABRICKS_MODEL_NAME`, and `DATABRICKS_TOKEN`. The token should **never** be committed—store real values in `env/.env.local.user` with the `SECRET_` prefix (e.g., `SECRET_DATABRICKS_TOKEN`).
	- Toggle `BYPASS_AUTHENTICATION`:
	  - `true` for local-only tools like Agents Playground or Bot Framework Emulator
	  - `false` (or remove it) when debugging in Copilot/Teams, because those channels send real JWTs

3. **Populate `.env` files** – run the Toolkit **Provision** task once to generate bot IDs:

	```powershell
	teamsapp provision --env local
	```

	This command prompts you to sign in, then writes values to `env/.env.local` and `env/.env.local.user`.

4. **Run unit tests** to confirm the environment:

	```powershell
	pytest
	```

5. **Debug locally**

	- **Agents Playground** (CLI):

	  ```powershell
	  func start --python --port 3978
	  agentsplayground -e "http://127.0.0.1:3978/api/messages" -c emulator
	  ```

	- **VS Code (Copilot or Teams)**: open the Run and Debug panel and choose one of:
	  - `Debug in Teams (Edge/Chrome)` – uses the `Start App Locally` task chain, spins up the dev tunnel, and sideloads the Teams app
	  - `(Preview) Debug in Copilot (Edge/Chrome)` – same task chain, but launches https://m365.cloud.microsoft/chat with `developerMode=Basic`

	During Copilot debugging set `BYPASS_AUTHENTICATION` to `false`; otherwise the bot rejects signed requests with `Invalid AppId passed on token`.

---

## Project structure

| Path | Purpose |
| --- | --- |
| `function_app.py` | Azure Functions v2 entry point exposing `/api/messages` |
| `app/bot.py` | Conversation logic wiring Databricks responses back to Teams/Copilot |
| `app/databricks_client.py` | OpenAI-compatible wrapper for Databricks Serving, including rich content flattening |
| `app/config.py` | Typed settings loader (raises if required env vars are missing) |
| `env/` | Toolkit-managed `.env.<environment>` files – never edit manually except for secrets in `.user` variants |
| `m365agents*.yml` | Toolkit lifecycle definitions for local/playground/prod environments |
| `infra/` | Bicep templates that provision Storage, Function App, Application Insights, and Bot registration |
| `appPackage/manifest.json` | Teams/Copilot manifest template (IDs replaced during provision) |
| `tests/` | `pytest` suite (config contract + Databricks content handling) |

---

## Running via Microsoft 365 Agents Toolkit

1. **Start App Locally** (F5 or command palette)
	- Validates ports/account access
	- Spins up a dev tunnel on port 3978 and writes `BOT_ENDPOINT` + `BOT_DOMAIN`
	- Provisions (or reuses) local resources and writes env vars
	- Deploys the function code locally (installs deps, copies env vars)
	- Starts `func start --python --port 3978` in a dedicated terminal

2. Browser launches (Teams or Copilot) after the function host logs `For detailed output, run func with --verbose flag.` The `.vscode/tasks.json` background matcher waits for that exact line so the UI no longer hangs.

3. **Agents Playground** task chain (`Start App in Microsoft 365 Agents Playground`) reuses most steps but doesn’t start the dev tunnel. Use it when you want to validate the agent via the CLI instead of Copilot/Teams.

---

## Deployment (sandbox or production)

Each environment has its own `.env` files under `env/`. To deploy:

```powershell
teamsapp provision --env sandbox
teamsapp deploy --env sandbox
```

Behind the scenes:

1. Bicep templates create/update Azure resources
2. Python dependencies are installed into `.python_packages`
3. `.webappignore` / `.funcignore` ensures only runtime files are zipped
4. Zip deploy pushes the function to Azure
5. Teams/Copilot manifest is rebuilt and synced

Remember to rotate secrets (Databricks tokens, bot passwords) directly in the `.env.<environment>.user` files. The Toolkit treats any variable that starts with `SECRET_` as sensitive and keeps it local.

---

## Databricks specifics

- Set `DATABRICKS_BASE_URL` to the *serving endpoint root*, not the classroom/workspace URL (e.g., `https://adb-<workspace>.azuredatabricks.net/serving-endpoints`).
- `app/databricks_client.py` normalizes the structured content returned by Databricks (lists, dicts with `text` fields, etc.) so the bot always sends plain strings back to Teams.
- The default system prompt lives in `local.settings.sample.json`—override `SYSTEM_PROMPT` per environment to customize behavior.

---

## Troubleshooting

| Symptom | Likely cause | Fix |
| --- | --- | --- |
| Browser never opens during F5 | Task waits for old log lines | `.vscode/tasks.json` already updated to watch for `Worker process started...` and `For detailed output…`. If that changes again, update the matcher. |
| Playground can’t reach `http://localhost:3978/api/messages` | Function host not running or bound to IPv6 | Start `func start` first and use `http://127.0.0.1:3978/api/messages`. |
| Copilot says “Sorry, something went wrong” | Auth bypass still enabled | Set `BYPASS_AUTHENTICATION=false` before running Copilot debug. |
| Git push rejected (secret scanning) | Real tokens in tracked files | Keep secrets in `.env.*.user` files (gitignored). If you leak a secret, rotate it and rewrite history. |

---

## Next steps

- Add GitHub Actions workflow that runs `pytest`, `teamsapp provision --env sandbox --interactive false`, and `teamsapp deploy --env sandbox`.  
- Instrument `DatabricksClient` with Application Insights telemetry for latency/error tracking.  
- Consider parameterizing `BYPASS_AUTHENTICATION` per-channel so Playground stays anonymous while Copilot always validates tokens.
